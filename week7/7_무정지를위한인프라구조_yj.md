# 7.1 안정성 및 이중화

- 안정성 (고가용성)
    - 시스템 서비스가 가능한 한 멈추지 않도록 하는 것
    - 
    
    | 안정성 고가용성의 목표 | 실현 수단 |
    | --- | --- |
    | 고장, 장애에 의한 정지가 발생하지 않을 것 | 컴포넌트 이중화 |
    | 고장, 장애가 발생해도 복구 할수 있을 것 | 컴포넌트 이중화 |
    | 고장, 장애가 발생한 것을 검출 할수 있을 것 | 컴포넌트 감시 |
    | 고장, 장애가 발생해도 데이터가 보호될 것 | 데이터 백업 |

## 이중화

- 하나의 기능을 병렬로 여러개 나열해서 하나에 장애가 발생해도 다른 것을 이용해서 서비스를 계속할 수 있는 것을 가리킨다
- 고가용성 + 확장성 + 부하분산
- 시스템 서비스를 지속적으로 제공하기 위해 기능을 이중화

### 어떤 구조를 사용?

- 부하분산 - 모두가 균등하게 가마를 들수 있어야함
- 내부적 생존 감시
- 마스터 결정
- 페일오버

### 이중화는 다양한 계층에서 적용 가능

- H/W 컴포넌트 계층
    - 전원, 네트워크, 하드디스크 이중화
- 시스템 계층
    - 여러 서버에서 동일한 처리를 실행하는 서버 이중화
- 물리적 위치 계층
    - 시스템을 서로 다른 위치 (데이터 센터나 클라우드)에서 운영하는 이중화
    - 데이터 센터의 정전이나 대규모 장애가 발생한 경우에도 시스템을 유지하는 것이 목적

# 7.2 서버 내 이중화

## 7.2.1 전원, 장치 등의 이중화

- 일반적인 서버 내부 컴포넌트에는 전원, 팬 등이 이중화
- 랙 뒤쪽의 양끝에는 전원 탭이 붙어 있음 - 이중화
    - 양쪽 전원탭의 전력 합계를 최대로 사용하는 것이 아님
    - 한쪽 전원탭 전력만으로 서버가 가동될 수 있도록 소비 전력 합계를 낮춤
        - 한쪽 전원이 공급되지 않아도 다른 한쪽의 전원만으로 시스템 가동 가능
- 대규모 데이터 센터에서는 각 전원 탭이 별도 분전반이나 UPS에 접속돼 있어서 전원 장애에 대비

## 7.2.1 네트워크 인터페이스 이중화

- PCI 슬롯에 꽂은 카드도 이중화 가능
- 네트워크 인터페이스가 여러개 있으면 이중화 소프트웨어나 기증을 이용해서 가용성과 성능 향성 가능
- 네트워크 인터페이스가 온보드에 존재 → 네트워크 컨트롤러와 버스가 두개 있음

### 장애가 발생하면?

- 네트워크 인터페이스 이중화는 **하드웨어 혹은 OS 로 구현**
- 엑티브-스텐바이 구성
    - 마스터-워커 개념에 기반
    - 스탠바이 측은 보통 서비스를 제공하지 않음
    - **페일오버**
        
        액티브 측에 어떤 문제가 발생하면, 스탠바이 장비로 교체 돼서 스탠바이가 액티브로 변경
        
- 본딩
    - 액티브-백업 : 액티브 스텐바이 구성
        - 어떤 인터페이스가 마스터가 되는지는 설정에서 구성
    - 이중화된 인터페이스를 감시하는 방식
        1. MII 감시
            1. MII 규격에 준거한 인터페이스의 링크 감시
            2. 링크업(인터페이스가 가동되는 것)이 동작하고 있으면 정상이라 판단
            - - 불필요한 폴링 패킷이 전송되지 않음
            - 폴링 위치로 지정한 IP 주소를 가진 장비에 대해서는 유지관리나 장애를 의식하지 않아도 됨
        2. ARP 감시
            1. 특정 IP주소로 ARP요청을 보내서 돌아오는 응답 유무에 따라 정상적인지 확인
            - ARP 요청을 정기적으로 실행해서 → 응답 있으면 정상이라 판단
            - ARP 요청은 MAC 주소를 확인하는 브로드캐스트
                - L2에서 실시
            - 단점 : 폴링이 되는 APR 요청이 동일 네트워크 내의 브로드 캐스트라 불필요한 트래픽이 증가
                - 불필요한 트래픽 고려해서 - 감시 빈도를 너무 높게 설정하지 않는 것이 좋음
                    - 1~2초 간격으로 설정
            - 페일오버 구조
                - 감시 방법에 상관없이 동일
                - 인터페이스가 페일오버하면, 스위치의 **MAC 주소 테이블이 변경** 되고 통신 재개
    - 인터페이스 이중화인 **본딩 구조**는 L3 네트워크보다 낮은 계층에서 구현되고 있음
    
    - ARP 감시에는 임의의 IP 주소에 대해 ARP 요청을 보낼 수 있음
        - 주로 네트워크 게이트 웨이로 요청 보냄
        - 감시 범위가 L2 스위치 전체
    - 반면 MII 감시는 인터페이스의 링크 상태를 확인
        - 때문에 접속돼 있는 L2 스위치만 감시
        

# 7.3 저장소 이중화

## 7.3.1 HDD 이중화

- HDD는 가동 빈도가 높아서 고장나기 쉬움
- 예전 SAN이라는 네트워크를 구축하는 방법이 유행
    - 구조 간단
- 현재 TCP/IP 프로토콜상에 네트워크를 구축하는 방식
    - TCP/IP + SCSI 프로토콜 이용 하는 등 여러 기술을 조합
    - 구조가 복잡

### 저장소 내부 구조와 RAID

- SAN에서는 IP주소 대신에 WWN 이라는 주소를 이용해서 데이터 전송
- HDD간을 연결하는 내부버스 - 다양한 규격이 있지만 SAS가 유명
- 상용 환경에서의 이중화
    - 컨트롤러에서는 CPU나 캐시가 있음, HDD의 I/O 제어
    - HDD는 전용 박스(엔클로저, 셀프)에 저장돼서 증설하기 쉬움
- HDD 자체 이중화 - RAID
    - HDD를 묶어서 그룹으로 만들고 이것을 논리적인 HDD로 인식하는 기술
    - 논리적 HDD : LU
- RAID 장점
    1. 안정성 확보
    2. 성능 향상
    3. 용량 확장
        - HDD는 자유롭게 용량 결정 가능

## RAID 구성 패턴

- RAIDI RAID5 RAID10
- RAID5
    - 이중화 확보를 위해 패리티라는 오류 수정 부호를 기록
    - 패리티를 하나의 HDD에 집중시키지 않고 분산
- 장애 발생시?
    - RAID10
        - HDD 가 고장나면 RAID에 포함된 데이터는 망가지지 않지만 이중화 구조가 망가짐
        - 이중화 회복을 위해 핫 스페어라고 하는 디스크 이용
            - 한대의 HDD가 고장나면 자동적으로 핫 스페어가 RAID에 포함돼서 이중화 구조를 회복

# 7.4 웹 서버 이중화 (소프트웨어 관점)

## 7.4.1 웹 서버의 서버 내 이중화

- 클라이언트의 http 프로토콜 요청을 받는 것은 웹 서버에 동작하고 있는 웹 서버 프로그램
- 클라이언트 관점
    - 서버측이 프로세스나 스레드 중 어떤걸로 가동되고 있는지 의식 X
    - 아파치에서는 어느쪽이든 미리 여러개 가동 시켜서 클라이언트 요청에 빠르게 대응할 수 있는 구성을 가지고 있음
    - 여러개 가동시켜 놓으면 프로세스/스레드가 가동되고 있기 대문에 웹서버의 서비스 전체가 정지되는 일은 없음

### 아파치 프로세스/스레드 동작 방식

- httpd
- ps-elf 명령 실행 결과로 프로세스와 스레드 상태 차이 알수 있음
- 상용 시스템은 일반적으로 시스템에 여유가 있으면
    - 가동 프로세스/데몬수의 최솟값 최대값이 같음
    - 동일 값으로 하면 프로세스나 스레드의 가동/정지 오버헤드를 줄일 수 있음

### 장애가 발생하면?

- httpd 프로세스/스레드가 요청을 받을 수 없는 경우 - 서버측 문제라 500 에러 반환
- 웹 서버에 대한 요청은 큐에 쌓이지 않고 바로 에러 반환

## 7.4.2 서버 이중화

- 웹 서버 자체 이중화
- 클라이언트는 URL 입력 → URL 내에는 호스트 명 포함, DNS 를 통해 이름 해석을 하여 실제 웹서버의 IP 주소를 찾음
1. DNS를 이용해서 호스트명에 대해 복수의 IP 주소를 반환 하는 것
    - DNS 라운드 로빈
        - 호스트명에 대해 복수의 IP 주소를 등록해 두는 것
            - DNS는 질의에 대해 순서대로 IP 주소 반환
        - 주의점
            1. DNS가 서버 상태를 감시해서 파악하지 않음 → 서버가 정지된 경우에도 그 서버의 주소 반환
            2. DNS가 세션 상태를 파악하지 않음 → 다음접속시에 동일 서버에 접속해야 하는 경우도 부적합

### 부하 분산 장치를 이용한 웹 서버 이중화

- 로드밸런서
    - 로드밸런서가 이전에 어느 웹 서버에 요청을 할당했는지 쿠키에 저장
        - 쿠키 : http 프로토콜의 메시지 헤더에 포함되는 요소
    - 클라이언트 측에서 쿠키 사용을 허가하면 두번째 이후 접속으로부터 http 요청 헤더에 쿠키를 저장해서 접속
    - 로드밸런서는 이 쿠키 읽어서 같은 서버에 요청 할당
    - 이를 통해 세션 상태 저장 - 세션 테이블
        - 세션 상태 저장을 실현하는 기능을 ‘퍼시스턴스’기능이라고 함
        - 주요 퍼시스턴스
            
            
            | 퍼시스턴트 종류 | 내용 |
            | --- | --- |
            | 소스 IP 주소 | 클라이언트 IP 주소를 기반으로 요청을 할당할 웹 서버를 결정 |
            | 쿠키 | http 헤더 내에 접속한 웹 서버 정보를 저장 (리디렉션) |
            | url | url 구조내에서 접속한 웹서버 정보 저장 |
- 주의 사항
    - 출발 IP 주소를 이용한 퍼시스턴스는 프록시를 경유하게 되면 프록시 서버의 IP 주소가 클라이언트 IP 주소가 돼서 요청이 한쪽으로 몰릴수도.
    - 쿠키를 사용하는 경우는 AP 서버 등이 쿠키를 사용할때 로드밸런서가 부여한 쿠키를 덮어쓰기 하지 않는지 확인해야함
    - URL에 정보를 심는 경우, URL은 사용자가 직접 편집 가능한 정보라 부정 접속에 대한 정책 검토해야 함
        - 해시함수를 이용해서 변경한 값을 심음
- 로드밸런서 장치의 첫 접속시에 서버 할당 알고리즘에도 몇가지 방식 존재
    - 라운드 로빈
    - 최소 연결
    - 응답시간
        - 서버의 CPU 사용률이나 응답시간 등을 고려해서 가장 부하가 적은 서버의 IP 주소에 요청 할당

### 장애가 발생하면?

- 동적 콘텐츠인 경우
    - 페일오버와 세션 정보가 사라지기 때문에 세션 상태 초기화
        - 이전 입력 내용이 사라지는 것
    - 장애시 세션 정보를 유지하기 위해서 페일오버 외의 다른 구조 필요
        - ex. 자바에서는 세션 정보 보호를 위한 구조 존재

# 7.5 AP 서버 이중화

## 서버 이중화

1. 로드밸런서 이용 혹은 AP 서버가 가진 웹서버 요청 이중화 기능을 이용해서 AP 서버 요청 분산
2. 세션 정보 이중화
    1. 세션 정보 : 애플리케이션 상태를 임시적으로 저장
- 요청의 분산 및 세션 정보 이중화 기능을 사용해 AP 서버 이중화
- 장애 발생시?
    - 페일오버 구조 - 쿠키 정보를 가지고 보조 세션 정보에 접속해서 세션이 계속 유지되는 것을 알 수 있음

## DB 연결 이중화

- AP 서버 3계층형 시스템의 중간에 위치
- 연결 풀링 : AP서버가 DB 서버에 접속시에 사용할 연결을 사전에 여러개 생성
    - 데이터 소스
        - 여러 연결을 만들어서 데이터 베이스 처리를 병렬로 실행할 수 있게 하는 구조
        - 장점
            - 애플리케이션이 DB 서버의 IP나 포트 등을 몰라도 된다 - 데이터 소스명만 알면 됨
- 장애 발생시?
    - 웹로직이 감시에 두번 실패 - 연결을 일단 끊은 후 재접속
    - 연결이 모두 사용중인 경우는?
        - 설정 최댓값까지 연결수가 늘며, 최댓값을 초과한 요구가 오면 일정 시간 대기함
        - 파라미터 : 연결 예약 타임 아웃
            - 이 경계 값까지 대기한 후 에러 반환
- 설계 방침
    1. 최솟값과 최댓값을 동일하게 설정
        - 연결을 생성하거나 제거할때 발생하는 오버헤드를 가능한 경감 시키기 위함
        - 연결 오버헤드를 초기 가동시에만 집중
    2. 방화벽 유무를 확인
        - 방화벽이 있으면 - 오랫동안 사용하지 않은 세션을 자동으로 제거하는 경우가 있음
        - 의도하지 않은 절단이 발생할수도 있음 → 정기적으로 폴링하는 등의 대책을 마련
